# Інструкція для Release Engineer / DevOps: Оновлення Проєкту "ShelterApp" у Production Середовищі (Windows 11)

Цей документ надає покрокові рекомендації щодо оновлення веб-додатку "ShelterApp", розгорнутого на Windows 11. Процес включає підготовку до оновлення, безпосередньо процес оновлення та налаштування конфігурації.

---

## 1. Підготовка до Оновлення

Цей етап є критично важливим для мінімізації ризиків, забезпечення цілісності даних та швидкого відновлення у випадку непередбачених проблем.

### 1.1. Створення Резервних Копій

Обов'язково створіть резервні копії всіх ключових компонентів системи перед початком оновлення.

* **Коду Проєкту (повної директорії):**
    Зробіть повну копію каталогу проєкту, що розгорнутий (`C:\ShelterApp`), в безпечне місце. Це дозволить швидко відновити попередню версію коду.
    ```powershell
    # Створіть папку для резервних копій, якщо її немає
    mkdir -Force C:\Backup

    # Скопіюйте весь каталог проекту з поточною датою та часом у назві
    $timestamp = Get-Date -Format "yyyyMMdd_HHmm"
    Copy-Item -Path "C:\ShelterApp" -Destination "C:\Backup\ShelterApp_Backup_$timestamp" -Recurse -Force
    ```
    * **Примітка:** Переконайтеся, що на диску `C:\Backup` (або іншому місці зберігання) достатньо вільного місця.

* **Бази Даних (`shelter.db`):**
    Оскільки використовується SQLite, база даних є файлом. Зробіть її копію.
    ```powershell
    # Скопіюйте файл бази даних у папку резервної копії, створену вище
    Copy-Item -Path "C:\ShelterApp\shelter.db" -Destination "C:\Backup\ShelterApp_Backup_$timestamp\shelter.db.bak" -Force
    ```
    * **Важливо:** Переконайтеся, що додаток зупинено перед копіюванням файлу `shelter.db`, щоб уникнути пошкодження даних під час копіювання.

### 1.2. Перевірка Сумісності

Перевірте зміни в новій версії коду, щоб виявити потенційні проблеми сумісності.

* **Зміни у Залежностях (`requirements.txt`):**
    * Перегляньте оновлений файл `requirements.txt` (якщо він є у новій версії коду).
    * Зверніть увагу на значні зміни версій бібліотек або додавання нових залежностей.
    * Переконайтеся, що нові версії бібліотек сумісні з поточною версією Python, встановленою на сервері (наприклад, Python 3.10).
* **Зміни в Коді, що Впливають на Базу Даних:**
    * Якщо нова версія коду містить зміни у моделях даних (наприклад, додавання/видалення колонок або таблиць), це вимагатиме міграції бази даних.
    * Перевірте, чи оновлений скрипт міграції (`init_db.py` або інший) готовий до запуску. Він має бути ідемпотентним (тобто може бути запущений кілька разів без пошкодження даних) та коректно застосовувати зміни без втрати існуючих даних.
    * *Для SQLite складні міграції даних можуть бути проблематичними; для критичних даних розгляньте ручну міграцію або використання більш надійних СУБД та інструментів міграції (наприклад, Alembic) у майбутньому.*
* **Версія Python:**
    * Переконайтеся, що нова версія коду не вимагає іншої (новішої або старішої) версії Python, ніж та, що вже встановлена на виробничому сервері.

### 1.3. Планування Часу Простою

Визначте оптимальний час для проведення оновлення.

* Виберіть період мінімального навантаження або повного відсутності трафіку до додатку, оскільки процес оновлення вимагатиме тимчасової зупинки сервісу.
* Якщо це публічний сервіс, заздалегідь повідомте користувачів про заплановані технічні роботи та очікуваний час простою.

---

## 2. Процес Оновлення

Ці кроки повинні виконуватися послідовно на виробничому сервері.

### 2.1. Зупинка Служб Додатку

Перед оновленням коду обов'язково зупиніть поточний екземпляр додатку, щоб уникнути конфліктів файлів та пошкодження даних.

* **Якщо додаток запущений через Планувальник завдань Windows:**
    1.  Відкрийте "Планувальник завдань" (Task Scheduler): Натисніть `Win + R`, введіть `taskschd.msc` і натисніть Enter.
    2.  Знайдіть завдання з ім'ям `Run ShelterApp Flask`.
    3.  Натисніть на нього правою кнопкою миші та оберіть **"Зупинити" (End)**.
* **Якщо додаток запущений вручну через консоль (`run_app.bat`):**
    1.  Перейдіть до вікна консолі, де запущено додаток.
    2.  Натисніть `Ctrl + C` (можливо, кілька разів), щоб зупинити процес.
    3.  Переконайтеся, що процес завершився.

### 2.2. Розгортання Нового Коду

Отримайте найновішу версію коду з вашого Git-репозиторію.

* **Перейдіть до кореневої папки проєкту:**
    ```powershell
    cd C:\ShelterApp
    ```
* **Переконайтеся, що ви перебуваєте в потрібній гілці** (зазвичай `main` або `master` гілка, яка розгортається на production).
    ```powershell
    git checkout main # або master
    ```
* **Виконайте `git pull` для завантаження останніх змін:**
    ```powershell
    git pull origin main # Замініть 'main' на вашу основну гілку, якщо вона інша
    ```
    * **Примітка:** Якщо під час `git pull` виникають конфлікти (наприклад, якщо ви вручну змінювали файли на сервері), їх потрібно вирішити. Зазвичай на production-сервері не рекомендується вносити ручні зміни до коду, який відстежується Git.

* **Оновлення віртуального середовища та залежностей:**
    Якщо `requirements.txt` змінився, вам потрібно оновити залежності у віртуальному середовищі.
    1.  **Активуйте віртуальне середовище:**
        ```powershell
        .\.venv\Scripts\activate
        ```
    2.  **Встановіть або оновіть залежності з `requirements.txt`:**
        ```powershell
        pip install -r requirements.txt
        ```
        * **Важливо:** Якщо ви раніше встановлювали `waitress` окремо, переконайтеся, що він також оновиться, якщо потрібно. Можливо, доведеться виконати `pip install --upgrade waitress`.

### 2.3. Міграція Даних (якщо потрібно)

Якщо нова версія коду вносить зміни до структури бази даних (наприклад, додає нові таблиці чи стовпці), виконайте міграцію.

* **Переконайтеся, що ви знаходитесь у корені проєкту (`C:\ShelterApp`) і віртуальне середовище активоване.**
* **Запустіть скрипт ініціалізації/міграції бази даних:**
    ```powershell
    python init_db.py
    ```
    * **Попередження:** Переконайтеся, що ваш `init_db.py` безпечний для повторного запуску та не призведе до втрати існуючих даних. В ідеалі, скрипт міграції повинен перевіряти стан БД перед застосуванням змін.

### 2.4. Оновлення Конфігурацій

Якщо нова версія додатку вимагає змін у конфігурації (наприклад, нові ключі API, змінені шляхи), оновіть їх.

* **Змінні Середовища Windows:**
    * Якщо оновлення включає нові або змінені змінні середовища (наприклад, `FLASK_SECRET_KEY`), оновіть їх у системних змінних Windows.
    * **Дії:** "Панель керування" -> "Система" -> "Додаткові параметри системи" -> "Змінні середовища". Знайдіть або додайте необхідні змінні.
    * *Зверніть увагу: після зміни системних змінних може знадобитися перезавантаження системи для їхнього повного застосування, або, як мінімум, перезапуск процесу, який їх використовує.*
* **Файли Конфігурації Проєкту (якщо є):**
    * Якщо ваш проєкт використовує окремі файли конфігурації (наприклад, `config.ini`, `.env`), які не відстежуються Git (і це правильно для секретних даних!), оновіть їх вручну на сервері, щоб вони відповідали вимогам нового коду.

### 2.5. Запуск Служб Додатку

Після успішного розгортання нового коду, міграції даних та оновлення конфігурацій, запустіть додаток.

* **Дія (через Планувальник завдань):**
    * Відкрийте "Планувальник завдань".
    * Знайдіть завдання `Run ShelterApp Flask`.
    * Натисніть на нього правою кнопкою миші та оберіть **"Запустити" (Run)**.
* **Або (якщо ви тестуєте вручну):**
    * Відкрийте нове вікно командного рядка у корені проєкту (`C:\ShelterApp`).
    * Виконайте `.\run_app.bat`.

---